<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Axxess Sales TV Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-[#667eea] to-[#764ba2] min-h-screen text-white">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Trophy, TrendingUp, Clock } = lucideReact;

    function SalesTVDashboard() {
      const [agents, setAgents] = useState([]);
      const [loading, setLoading] = useState(true);
      const [currentTime, setCurrentTime] = useState(new Date());

      useEffect(() => {
        loadAgents();
        const interval = setInterval(loadAgents, 5000);
        const clockInterval = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => {
          clearInterval(interval);
          clearInterval(clockInterval);
        };
      }, []);

      const loadAgents = async () => {
        try {
          const result = await window.storage.list("agent:", true);
          if (result && result.keys) {
            const agentData = await Promise.all(
              result.keys.map(async (key) => {
                try {
                  const data = await window.storage.get(key, true);
                  return data ? JSON.parse(data.value) : null;
                } catch {
                  return null;
                }
              })
            );
            setAgents(agentData.filter((a) => a !== null));
          }
        } catch (error) {
          console.error("Error loading agents:", error);
        }
        setLoading(false);
      };

      const calculateTeamStats = (deptAgents) => {
        const totalSales = deptAgents.reduce((sum, a) => sum + (a.sales || 0), 0);
        const totalTarget = deptAgents.reduce((sum, a) => sum + (a.target || 0), 0);
        const progress = totalTarget > 0 ? (totalSales / totalTarget) * 100 : 0;
        return { totalSales, totalTarget, progress };
      };

      const salesDept = agents.filter((a) => a.department === "Sales");
      const clientCareDept = agents.filter((a) => a.department === "Client Care");

      const salesStats = calculateTeamStats(salesDept);
      const clientCareStats = calculateTeamStats(clientCareDept);

      const getBarColor = (progress) => {
        if (progress >= 100) return "bg-green-400";
        if (progress >= 75) return "bg-blue-400";
        if (progress >= 50) return "bg-yellow-400";
        return "bg-red-400";
      };

      const DepartmentSection = ({ title, agents, stats }) => (
        <div className="bg-white/10 backdrop-blur-md rounded-3xl p-8 shadow-2xl mb-10">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-4xl font-bold flex items-center gap-3">
              <TrendingUp className="w-10 h-10" /> {title}
            </h2>
            <div className="text-right">
              <p className="text-sm opacity-80">Team Progress</p>
              <p className="text-3xl font-bold text-green-300">{stats.progress.toFixed(1)}%</p>
            </div>
          </div>

          <div className="w-full bg-white/20 rounded-full h-4 overflow-hidden mb-8">
            <div
              className={`h-full transition-all duration-1000 ${getBarColor(stats.progress)}`}
              style={{ width: `${Math.min(stats.progress, 100)}%` }}
            ></div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {agents.length === 0 ? (
              <p className="text-gray-200 text-center col-span-2">No agents found</p>
            ) : (
              agents.map((a, idx) => {
                const progress = a.target > 0 ? (a.sales / a.target) * 100 : 0;
                return (
                  <div
                    key={a.id}
                    className="bg-white/10 p-6 rounded-2xl shadow-md transition-transform hover:scale-[1.02]"
                  >
                    <div className="flex justify-between items-center mb-3">
                      <h3 className="text-2xl font-semibold">{a.name}</h3>
                      {idx === 0 && <Trophy className="text-yellow-400 w-8 h-8" />}
                    </div>
                    <div className="w-full bg-white/20 rounded-full h-3 mb-2">
                      <div
                        className={`h-full ${getBarColor(progress)} transition-all duration-1000`}
                        style={{ width: `${Math.min(progress, 100)}%` }}
                      ></div>
                    </div>
                    <p className="text-sm opacity-80">{progress.toFixed(1)}% to target</p>
                  </div>
                );
              })
            )}
          </div>
        </div>
      );

      const formattedTime = currentTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      const formattedDate = currentTime.toLocaleDateString(undefined, { weekday: "long", month: "long", day: "numeric" });

      return (
        <div className="min-h-screen p-8 relative">
          {/* Clock */}
          <div className="absolute top-6 right-8 text-right">
            <p className="text-2xl font-semibold">{formattedTime}</p>
            <p className="text-sm opacity-80">{formattedDate}</p>
          </div>

          {/* Logo */}
          <div className="flex justify-center mb-10">
            <img
              src="https://scontent.fplz1-1.fna.fbcdn.net/v/t39.30808-6/272700933_5148348905178892_6403204965564743457_n.png?_nc_cat=108&ccb=1-7&_nc_sid=783fdb&_nc_ohc=AA7lmVPRCSsQ7kNvgF0Q5T4&_nc_ht=scontent.fplz1-1.fna&oh=00_AYCgg3vGtrmWktSrxniEytP9G9-8A0uKjM9ac1vw4rMXqA&oe=6768C0E9"
              alt="Axxess Logo"
              className="h-24 drop-shadow-lg"
            />
          </div>

          <h1 className="text-5xl font-bold mb-10 text-white drop-shadow-md text-center">
            Axxess Sales Performance Dashboard
          </h1>

          {loading ? (
            <p className="text-center text-lg text-gray-100">Loading data...</p>
          ) : (
            <>
              <DepartmentSection title="Sales Department" agents={salesDept} stats={salesStats} />
              <DepartmentSection title="Client Care Department" agents={clientCareDept} stats={clientCareStats} />
            </>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<SalesTVDashboard />);
  </script>

  <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.min.js"></script>

</body>
</html>
